<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body, html {
  --accentColor: #004144;
  height: 100%;
  margin: 0;
}

.bg {
  /* The image used */
  background-image: url("bg.png");

  /* Full height */
  height:300vh;

  /* Center and scale the image nicely */
  background-position: center;
  background-repeat: no-repeat;
  background-size: 100% 100%;
}



    .Launcher {
      position: fixed;
      bottom: 32px;
      right: 32px;
      border: none;
      margin: 0;
      padding: 0;
      outline: none;
      box-shadow: 1px 0 4px rgba(23, 23, 23, 0.3);
      display: flex;
      background-color: #EE1A24;
      align-items: stretch;
      cursor: pointer;
    }

    .Launcher__Icon {
      width: 48px;
      height: 48px;
      padding: 20px;
      color: var(--accentColor);
      border-color: transparent;
      border-width: 1px 0 1px 1px;
      border-style: solid;
    }

    .Launcher:focus .Launcher__Icon {
      border-color: var(--accentColor);
    }

    .Launcher:hover .Launcher__Icon {
      background-color: #8E0D13;
    }

    .Launcher__TextContainer {
      flex: 1;
      display: flex;
      align-items: center;
      background-color: var(--accentColor);
      color: #EE1A24;
      border-color: var(--accentColor);
      border-width: 1px 1px 1px 0;
      border-style: solid;
    }

    .Launcher:focus .Launcher__TextContainer {
      box-shadow: inset 0 0 0 1px #EE1A24;
    }

    .Launcher:hover .Launcher__TextContainer {
      opacity: 0.8;
    }

    .Launcher__Text {
      width: 180px;
      padding: 16px;
      text-align: left;
      font-size: 16px;
      line-height: 24px;
    }

    .InlineLauncher {
      width: 16px;
      height: 16px;
      border: none;
      margin: 0;
      padding: 0;
      outline: none;
      background-color: #EE1A24;
      cursor: pointer;
    }
</style>
</head>
<body>

<div class="bg"></div>
<button class="Launcher" type="button">
  <svg class="Launcher__Icon" focusable="false" preserveAspectRatio="xMidYMid meet" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" fill="currentColor">
    <g clip-path="url(#clip0_2_55)">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M17.552 8.29264V26.7042H26.5407C26.6366 26.7042 26.7122 26.7827 26.7122 26.8789V28.8279C26.7122 28.9241 26.634 29.0025 26.5407 29.0025H6.76204C6.66618 29.0025 6.58797 28.9241 6.58797 28.8279V26.8789C6.58797 26.7827 6.66618 26.7042 6.76204 26.7042H15.7507V8.30023C14.9687 8.02687 14.3481 7.40674 14.0756 6.62208H8.39176V7.49026C8.39176 7.58645 8.31356 7.66238 8.22021 7.66238H6.76204C6.66618 7.66238 6.58797 7.58392 6.58797 7.49026V6.62208H5.14242C5.03141 6.62208 4.94059 6.54361 4.94059 6.44996V4.98442C4.94059 4.88824 5.03141 4.80977 5.14242 4.80977H14.0806C14.454 3.75681 15.4581 3 16.6388 3C17.8194 3 18.8235 3.75681 19.1969 4.81231H28.1603C28.2713 4.81231 28.3621 4.89077 28.3621 4.98695V6.44996C28.3621 6.54614 28.2713 6.62208 28.1603 6.62208H26.5306V7.49026C26.5306 7.58645 26.4524 7.66238 26.359 7.66238H24.9009C24.805 7.66238 24.7268 7.58392 24.7268 7.49026V6.62208H19.2044C18.9345 7.39914 18.324 8.01421 17.552 8.29264ZM26.1421 8.64447L31.9218 18.8906C31.9722 18.9792 31.995 19.0754 31.9924 19.169H31.9975C31.9975 19.1817 31.9975 19.1943 31.9975 19.207C31.9975 21.647 29.1341 23.6264 25.6022 23.6264C22.1082 23.6264 19.27 21.69 19.2095 19.2854C19.1994 19.2449 19.1943 19.1994 19.1943 19.1563C19.1943 19.045 19.2297 18.9387 19.2877 18.8526L25.1986 8.61916C25.3474 8.36098 25.6754 8.27239 25.9327 8.42173C26.026 8.47995 26.0967 8.55588 26.1421 8.64447ZM26.1648 10.8744V18.6197H30.5343L26.1648 10.8744ZM25.1355 18.6172V10.8871L20.6676 18.6172H25.1355ZM7.94775 8.64447L13.7275 18.8906C13.7779 18.9792 13.8006 19.0754 13.7981 19.169H13.8031C13.8031 19.1817 13.8031 19.1943 13.8031 19.207C13.8031 21.647 10.9398 23.6264 7.40788 23.6264C3.91382 23.6264 1.07568 21.69 1.01514 19.2854C1.00505 19.2475 1 19.2044 1 19.1589C1 19.0475 1.03532 18.9412 1.09334 18.8551L7.00423 8.62169C7.15308 8.36351 7.48104 8.27492 7.73836 8.42426C7.8317 8.47995 7.90234 8.55588 7.94775 8.64447ZM7.97046 10.8744V18.6197H12.3399L7.97046 10.8744ZM6.93864 18.6172V10.8871L2.47331 18.6172H6.93864ZM16.6388 4.53641C17.2922 4.53641 17.8219 5.06795 17.8219 5.72352C17.8219 6.37909 17.2922 6.91063 16.6388 6.91063C15.9854 6.91063 15.4556 6.37909 15.4556 5.72352C15.4556 5.06795 15.9854 4.53641 16.6388 4.53641Z" fill="white"/>
      </g>
      <defs>
      <clipPath id="clip0_2_55">
      <rect width="31" height="26" fill="white" transform="translate(1 3)"/>
      </clipPath>
      </defs>
  </svg>



    
  <!-- <div class="Launcher__TextContainer">
    <div class="Launcher__Text">Hi! Iâ€™m a virtual assistant.<br/>How can I help you?</div>
  </div> -->
</button>

</body>
</html>
<script>

let webChatInstance;
    const launcherElement = document.querySelector('.Launcher');
    launcherElement.addEventListener('click', openWindow);

    // const inlineLauncherElement = document.querySelector('.InlineLauncher');
    // inlineLauncherElement.addEventListener('click', openWindow);

    /**
     * This will be called when the user clicks the launcher button.
     */
    function openWindow() {
      if (webChatInstance) {
        // See https://web-chat.global.assistant.watson.cloud.ibm.com/docs.html?to=api-instance-methods#openwindow for
        // more information on this function.
        webChatInstance.openWindow();
      }
    }

    /**
     * This function is called when web chat is closed. It will un-hide the launcher.
     */
    function closeHandler() {
      launcherElement.style.display = '';
    }

    /**
     * This function is called when web chat is closed. It will hide the launcher.
     */
    function openHandler() {
      launcherElement.style.display = 'none';
    }

 // We are going to save the message history here.
 let messages = [];
    let agentMessages = [];
    function preSendhandler(event) {
      event.data.context.skills['actions skill'] = event.data.context.skills['actions skill'] || {};
      event.data.context.skills['actions skill'].skill_variables = event.data.context.skills['actions skill'].skill_variables || {};
      event.data.context.skills['actions skill'].skill_variables.wa_messages = messagesToLines(messages);  
      event.data.context.skills['actions skill'].skill_variables.agent_messages = messagesToLines(agentMessages);
       
  }
    /**
     * This function will save all the messages that came from session history. These are messages that are loaded if
     * the web page is re-loaded or the user navigates to a different page in the middle of a conversation. This does
     * not include messages with a human agent which are not stored in session history.
     */
    function saveHistory(event) {
      messages.push(...event.messages);
    }

    /**
     * This function will save each message that is generated by the send and receive events.
     */
    function saveMessage(event) {
      messages.push(event.data);
    }

    /**
     * This function will save each message that is generated by the send and receive events with a human agent.
     */
    function saveAgentMessage(event) {
      agentMessages.push({
        ...event.data,
        // Add the agent's nickname to this object to make it easier to process both the bot and agent messages.
        agentNickname: (event.agentProfile && event.agentProfile.nickname) || 'Agent',
      });
    }
     /**
     * Converts the given array of messages into an array of "lines" that will correspond to lines in the output file.
     */
     function messagesToLines(messages) {
      // We're going to create a comma-separate-value file (CSV). The first column will indicate if the message came
      // from the user or if it came from the bot. The second column will be the text of the message. This code here
      // only supports text responses but it can be updated to support additional types of messages such as "option"
      // responses (buttons and dropdowns) or "connect_to_agent" response. You can find more information about the
      // possible types of responses here: https://cloud.ibm.com/apidocs/assistant/assistant-v2#message-response.
      const downloadLines = [];

      messages.forEach(message => {
        const inputText =message.input&& message.input.text && message.input.text.trim();
        if (inputText) {
          // This is a message that came from the user.
          downloadLines.push(inputText);
        } else if (message.output && message.output.generic && message.output.generic.length) {
          // This is a message that came from the assistant or an agent. It can contain an array of individual message items.
         
          message.output.generic.forEach(messageItem => {
            // This is only handling a text response but you can handle other types of responses here as well as
            // custom responses.
            const text =messageItem && messageItem.text &&  messageItem.text.trim();
            if (text) {
              downloadLines.push(text);
            }
          });
        }
      });

      return downloadLines.join('\\n');
    }

    /**
     * This is the function that is called when the web chat code has been loaded and it is ready to be rendered.
     */
    function onLoad(instance) {
      // Save a reference to the web chat instance so we can use it later.
      webChatInstance = instance;
      instance.render();
      
      instance.on({ type: 'send', handler: saveMessage });
      instance.on({ type: 'receive', handler: saveMessage });
      instance.on({ type: 'agent:send', handler: saveAgentMessage });
      instance.on({ type: 'agent:receive', handler: saveAgentMessage });
      instance.on({ type: 'history:begin', handler: saveHistory });
      instance.on({ type: 'pre:send', handler: preSendhandler });

      // Add listeners so we know when web chat has been opened or closed.
      // See https://web-chat.global.assistant.watson.cloud.ibm.com/docs.html?to=api-events#summary for more about our
      // events.
      instance.on({ type: 'window:close', handler: closeHandler });
      instance.on({ type: 'window:open', handler: openHandler });
      instance.on({
        type: 'identityTokenExpired',
        handler: function(event) {
          console.log({type: "identityTokenExpired"});
          // Perform whatever actions you need to take on your system to get a new token.
          return new Promise(function(resolve, reject) {
            fetch(jwtBaseUrl + cadePhoneNumber)
              .then(function(response) {
                return response.json();
              })
              .then(function (data) {
                event.identityToken = data.jwt;
                resolve();
              })
              .catch(function(err) {
                console.log('Fetch Error :-S', err);
              });
          });
        }
      });
      // We will need to listen for the "pre:receive" event
      instance.on({
        type: 'pre:receive',
        handler: function(event) {
          const message = event.data;
          console.log({type: "pre:receive", message});
          const skillVars = message.context.skills['actions skill'].skill_variables;
          if (skillVars.user_profile) {
          
            cadePhoneNumber = skillVars.user_profile.phone_number;
          
          }
            
        }
      });
     
    }
    

  let freshJWT; // "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJiZXR0ZXItY2hhdC1zYXVsLmNvbSIsInN1YiI6ImZyYW5jZXNjYSIsImlhdCI6MTY3MTEyMDA0OSwiZXhwIjoxNjcxMjkyODQ5fQ.NTrZ4Mm_CIPoksLP7TyRxaIXWfyInuvhAmUkTl_QOIQX0OgmlHIPgHGpwX2bp3a-qB_UvqLBFaYjtI3CqCHCAh3dEtTqyo1_Ud9g5WBTBUcG2a-A1eKo4LiMvyCrEHeT16vUZFv5rSxZReBAYalSPEMMcnehXM9WiCFcYmvB1jnAp55cVb7NoQodhkdiSh29-izWpZQBxe2yMbvYcV3gKsvaPDVDyb2yknEh0tR_dc-baADwVh2wzlZ5ujvQ5QYohYYltP_LsytQQhio5GBzJYLbuYPE7Wru5qlGdNBPSfCxVS1gNPfvkwEXt7_Xul_IAWJzUUqK8oK8k3_uyIyxDw";
  let cadePhoneNumber = "";
  const jwtBaseUrl = "https://dc17-176-230-36-50.ngrok.io/hackathon/login?phone_number=";

  window.watsonAssistantChatOptions = {
    integrationID:     "0415ed38-3d80-4956-9121-b2f9175d9fe0",
    region:            "dev",
    serviceInstanceID: "2dd79c90-d0d2-4997-9f52-8b94faccec0b",
    subscriptionID:    "0fcc042c5b45414b99850fbd38840ad9",
    showLauncher: false,
    // identityToken:     'YOUR_JWT',
    onLoad: onLoad
      
  };
  setTimeout(function(){
    const t=document.createElement('script');
    t.src="https://web-chat.global.assistant.watson.appdomain.cloud/loadWatsonAssistantChat.js";
    document.head.appendChild(t);
  });
</script>